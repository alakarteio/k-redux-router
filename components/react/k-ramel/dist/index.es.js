import{router as e,selectors as t,actions as r}from"@k-redux-router/core";import{applyMiddleware as o}from"k-ramel";import n from"react";import{inject as s}from"@k-ramel/react";import u from"prop-types";function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},o=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),o.forEach(function(t){i(e,t,r[t])})}return e}function a(e,t){if(null==e)return{};var r,o,n=function(e,t){if(null==e)return{};var r,o,n={},s=Object.keys(e);for(o=0;o<s.length;o++)r=s[o],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(o=0;o<s.length;o++)r=s[o],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var l=(n={})=>{const{routes:s,path:u="ui.router",getState:i=(e=>e.ui.router)}=n,{middleware:a,reducer:l,init:d}=e(s,{getState:i});return{getDriver:e=>c({},Object.entries(r).reduce((t,[r,o])=>c({},t,{[r]:(...t)=>e.dispatch(o(...t))}),{}),Object.entries(t(i)).reduce((t,[r,o])=>{let n=()=>o(e.getState());return["getRoute","getPathParam","getQueryParam","getParam"].includes(r)&&(n=(...t)=>o(...t)(e.getState())),c({},t,{[r]:n})},{})),getReducer:()=>({path:u,reducer:l}),getEnhancer:()=>o(a),init:e=>{e.dispatch(d())}}};const d=(e,t)=>r=>{var o,s;return s=o=class extends n.Component{constructor(r,o){super(r,o),i(this,"toShow",()=>{const{store:r}=this.context,{router:o}=r.drivers;if(!o.getState()||!o.getResult())return void console.error("[k-redux-router] | There is no route found in `state.ui.router.result`");if(!o.isFound()){const e=t&&t.notFound;return void this.setState(t=>c({},t,{show:e}))}const n=[].concat(e);let s=o.getCurrentRoute();if(t&&t.absolute){const e=n.includes(s.code);return void(e!==this.state.show&&this.setState(t=>c({},t,{show:e})))}let u=n.includes(s.code);for(;s&&s.parent&&!u;)s=o.getRoute(s.parent),u=n.includes(s.code);u!==this.state.show&&this.setState(e=>c({},e,{show:u}))}),this.state={show:!1}}componentWillMount(){const{store:e}=this.context;this.unsubscribe=e.subscribe(()=>{this.toShow()}),this.toShow()}componentWillUnmount(){this.unsubscribe()}render(){const{show:e}=this.state;return e?n.createElement(r,this.props):null}},i(o,"displayName",(e=>`router(${e.displayName||e.name||e.constructor&&e.constructor.name||"Unknown"})`)(r)),i(o,"contextTypes",{store:()=>null}),s};d.absolute=(e,t)=>d(e,c({},t,{absolute:!0})),d.notFound=e=>d(void 0,c({},e,{notFound:!0}));const h=e=>{const{href:t,onClick:r}=e,o=a(e,["href","onClick"]),{className:s,children:u}=o;if(void 0===t)return null;let i="",c=t;return t.base&&(c=t.base),t.compiled&&(c=t.compiled(o)),o.query&&(i=`?${(e=>Object.keys(e).map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`).join("&"))(o.query)}`),c=`${c}${i}`,n.createElement("a",{className:s,href:c,onClick:r},u)};h.propTypes={className:u.string,children:u.node,href:u.oneOfType([u.string,u.shape({base:u.string,compiled:u.func})]),onClick:u.func},h.defaultProps={className:void 0,children:void 0,href:void 0,onClick:void 0};var p=s((e,t,{router:r})=>{let{onClick:o,code:n,query:s}=t,u=a(t,["onClick","code","query"]);return{href:u.href||r.getRoute(n)&&r.getRoute(n).href,onClick:e=>{o&&o(e),(e=>(e=>!!(e.shiftKey||e.altKey||e.metaKey||e.ctrlKey))(e)||(e=>e.button&&0!==e.button)(e)||e.defaultPrevented)(e)||(r.push(n,u,s),e.preventDefault())}}})(h);export{p as Link,d as forRoute,l as router};
