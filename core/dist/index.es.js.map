{"version":3,"file":"index.es.js","sources":["../src/actions.js","../src/middleware.js","../src/selectors.js","../src/init.js","../src/factory.js","../src/reducer.js"],"sourcesContent":["export const push = (code, pathParams, queryParams) => ({\n  type: '@@router/PUSH',\n  payload: {\n    code,\n    params: {\n      path: pathParams,\n      query: queryParams,\n    },\n  },\n})\n","/* eslint-env browser */\n\n// https://stackoverflow.com/questions/1714786/query-string-encoding-of-a-javascript-object\nconst toQueryString = obj => Object.keys(obj).map(k => `${encodeURIComponent(k)}=${encodeURIComponent(obj[k])}`).join('&')\n\n// https://stackoverflow.com/questions/8648892/convert-url-parameters-to-a-javascript-object\nconst queryToObject = () => {\n  const { location } = window\n\n  if (location.search.length < 2) return {}\n\n  const search = location.search.substring(1)\n  return JSON.parse(`{\"${decodeURI(search).replace(/\"/g, '\\\\\"').replace(/&/g, '\",\"').replace(/=/g, '\":\"')}\"}`)\n}\n\nconst routeFound = result => ({ type: '@@router/ROUTE_FOUND', payload: Object.assign({ found: true }, result) })\n\nconst dispatchResultFactory = reducer => (store) => {\n  if (window && window.location && window.location.pathname) {\n    // find route (& path params)\n    let pathParams\n    const route = reducer.getState(store.getState()).routes.array.find((r) => {\n      pathParams = r.href.regexp.exec(window.location.pathname)\n      return !!pathParams\n    })\n\n    // attach names to path params\n    pathParams = route.href.parsed\n      .map(part => part.name)\n      .filter(Boolean)\n      .reduce(\n        (acc, curr, index) => Object.assign({ [curr]: pathParams[index + 1] }, acc),\n        {},\n      )\n\n    store.dispatch(routeFound({\n      route,\n      params: {\n        path: pathParams,\n        query: queryToObject(),\n      },\n    }))\n  }\n}\n\nconst mapActionFactory = reducer => store => (action) => {\n  const { type, payload } = action\n\n  switch (type) {\n    case '@@router/PUSH': {\n      const { code, params } = payload\n\n      // find route\n      const route = reducer.getState(store.getState()).routes.map[code]\n\n      // update history API\n      if (route) {\n        const { href } = route\n        let queryPart = ''\n\n        let toPush = href.base\n        if (href.compiled) toPush = href.compiled(params.path)\n        if (params.query) queryPart = `?${toQueryString(params.query)}`\n\n        window.history.pushState(undefined, undefined, `${toPush}${queryPart}`)\n      }\n\n      // TODO: if no route, find the closest `notFound` to push it in `result`\n\n      // update state\n      return routeFound({\n        route,\n        params,\n      })\n    }\n    // default is undefined so we avoid infinite loop\n    default: return undefined\n  }\n}\n\nexport default (routes, options, reducer) => {\n  let initialized = false\n  const dispatchResult = dispatchResultFactory(reducer)\n  const mapAction = mapActionFactory(reducer)\n\n  // redux middleware\n  return store => next => (action) => {\n    // these action are not catched by the middleware and are used as it is\n    if (!action.type || !action.type.startsWith('@@router/')) return next(action)\n\n    // dispatch base action so other lib and reducer can plug to it\n    const res = next(action)\n\n    // init watchers (location/INIT)\n    // - this is done here because we can't dispatch when middlewares tree is initialized by redux\n    // - so we make sure that the dispatch are done when we are initialized\n    if (action.type === '@@router/INIT') {\n      dispatchResult(store) // TODO: move to store.dispatch pattern\n\n      if (initialized) {\n        console.warn('[k-redux-router] initialized twice') // eslint-disable-line no-console\n      } else {\n        initialized = true\n\n        // watcher (location)\n        window.onpopstate = () => { dispatchResult(store) } // TODO: move to store.dispatch pattern\n      }\n    }\n\n    if (!initialized && action.type !== '@@router/ROUTE_FOUND') console.warn('[k-redux-router] router should be initialized') // eslint-disable-line no-console\n\n    // router actions can found a new route\n    const newAction = mapAction(store)(action)\n    if (newAction) store.dispatch(newAction)\n\n    return res\n  }\n}\n","export default (getState) => {\n  const getRoute = code => state => getState(state).routes.map[code]\n  const getResult = state => getState(state).result\n  const getCurrentCode = state => getRoute(state).code\n  const getCurrentRoute = state => getResult(state).route\n  const isFound = state => getResult(state).found\n  const getParams = state => getResult(state).params\n  const getPathParams = state => getParams(state).path\n  const getQueryParams = state => getParams(state).query\n  const getPathParam = code => state => getPathParams(state)[code]\n  const getQueryParam = code => state => getQueryParams(state)[code]\n  const getParam = code => state => getPathParam(code)(state) || getQueryParam(code)(state)\n\n  return {\n    getState,\n    getRoute,\n    getResult,\n    getCurrentCode,\n    getCurrentRoute,\n    isFound,\n    getParams,\n    getPathParams,\n    getQueryParams,\n    getPathParam,\n    getQueryParam,\n    getParam,\n  }\n}\n","export default () => ({ type: '@@router/INIT' })\n","/* eslint-env browser */\nimport pathToRegexp from 'path-to-regexp'\nimport middleware from './middleware'\nimport reducer from './reducer'\nimport init from './init'\n\nconst isRoute = route => typeof route === 'object' && route.code\n\nconst getFullHrefVersion = (routes) => {\n  const fullVersion = []\n\n  const addRoute = (base, parent, route) => {\n    // parameters to copy from parent to route\n    let propertiesToCopy = {}\n    if (parent) {\n      propertiesToCopy = Object\n        .entries(parent)\n        // eslint-disable-next-line no-unused-vars\n        .filter(([key, value]) => !isRoute(value)) // remove children routes\n        .reduce(\n          (acc, [key, value]) => Object.assign(acc, { [key]: value }),\n          {},\n        )\n    }\n\n    // process href and add to array\n    let innerRoute = route\n    if (parent) {\n      innerRoute = Object.assign(\n        propertiesToCopy,\n        route,\n        {\n          parent: parent && parent.code,\n          href: {\n            base,\n            compiled: (base.includes(':') ? pathToRegexp.compile(base) : undefined),\n            regexp: pathToRegexp(base),\n            parsed: pathToRegexp.parse(base),\n          },\n        },\n      )\n\n      fullVersion.push(innerRoute)\n    }\n\n    // process children\n    Object\n      .entries(route)\n      .filter(([key, value]) => isRoute(value)) // eslint-disable-line no-unused-vars\n      .forEach(([href, childRoute]) => addRoute([base, href].join('').replace('//', '/'), innerRoute, childRoute))\n  }\n\n  // start the graph\n  addRoute('', undefined, routes)\n\n  // update links\n  fullVersion.forEach((route) => {\n    // children\n    Object\n      .entries(route)\n      .forEach(([key, value]) => {\n        let newValue = value\n        if (isRoute(value)) newValue = value.code\n\n        route[key] = newValue // eslint-disable-line no-param-reassign\n      })\n  })\n\n  return fullVersion\n}\n\nexport default (routes, options = {}) => {\n  // get history implementation (default is window.history _this is history API_)\n  let { history } = options\n  if (!history && window && window.history) history = window.history // eslint-disable-line prefer-destructuring\n  if (!history) throw new Error('[k-redux-router] no history implementation is given')\n\n  // transform route\n  const innerRoutes = { array: getFullHrefVersion(routes) }\n  innerRoutes.map = innerRoutes.array.reduce(\n    (acc, curr) => Object.assign({}, acc, { [curr.code]: curr }),\n    {},\n  )\n\n  // implementations\n  const reducerImpl = reducer(innerRoutes, options)\n  return ({\n    middleware: middleware(innerRoutes, options, reducerImpl),\n    reducer: reducerImpl,\n    init,\n  })\n}\n","import * as actions from './actions'\nimport selectors from './selectors'\n\nexport default (routes, options) => {\n  // init redux state\n  const initState = Object.assign(\n    {},\n    {\n      routes,\n      result: { found: false },\n    },\n  )\n\n  const reducer = (state = initState, { type, payload } = {}) => {\n    switch (type) {\n      case '@@router/ROUTE_FOUND': return Object.assign({}, state, { result: payload })\n      default: return state\n    }\n  }\n\n  // selectors\n  Object.assign(reducer, selectors(options.getState || (state => state.ui.router)))\n\n  // actions\n  Object.assign(reducer, actions)\n\n  return reducer\n}\n"],"names":["const","code","pathParams","queryParams","type","payload","params","path","query","routeFound","result","Object","assign","found","dispatchResultFactory","reducer","store","window","location","pathname","let","route","getState","routes","array","find","r","href","regexp","exec","parsed","map","part","name","filter","Boolean","reduce","acc","curr","index","dispatch","search","length","substring","JSON","parse","decodeURI","replace","queryToObject","mapActionFactory","action","obj","queryPart","toPush","base","compiled","keys","k","encodeURIComponent","join","history","pushState","undefined","getRoute","state","getResult","getParams","getPathParams","getQueryParams","getPathParam","getQueryParam","isRoute","getFullHrefVersion","fullVersion","addRoute","parent","propertiesToCopy","entries","ref","innerRoute","includes","pathToRegexp","compile","push","forEach","childRoute","key","value","newValue","options","Error","innerRoutes","reducerImpl","initState","selectors","ui","router","actions","middleware","initialized","dispatchResult","mapAction","next","startsWith","res","console","warn","onpopstate","newAction","init"],"mappings":"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"}