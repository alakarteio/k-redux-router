import r from"path-to-regexp";var t=function(r){return function(t,e,n){return{type:r,payload:{code:t,params:{path:e,query:n}}}}},e={push:t("@@router/PUSH"),replace:t("@@router/REPLACE"),goBack:function(r){return void 0===r&&(r=1),{type:"@@router/GO_BACK",payload:r}},goForward:function(r){return void 0===r&&(r=1),{type:"@@router/GO_FORWARD",payload:r}}},n="@@router/ROUTE_FOUND",o=Object.assign(function(r){return{type:n,payload:Object.assign({found:!0},r)}},{type:n});function u(r,t){return function(e){var n=r.location;if(n.pathname){var u,a=t.getState(e.getState()).routes.array.find(function(r){return!!(u=r.href.regexp.exec(n.pathname))});if(!a)return;u=a.href.parsed.map(function(r){return r.name}).filter(Boolean).reduce(function(r,t,e){var n;return Object.assign(((n={})[t]=u[e+1],n),r)},{}),e.dispatch(o({route:a,params:{path:u,query:function(r){if(r.search.length<2)return{};var t=r.search.substring(1);return JSON.parse('{"'+decodeURI(t).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}')}(n)}}))}}}function a(r,t){var e=r.history;return function(r){return function(n){var u,a=n.type,i=n.payload;switch(a){case"@@router/GO_FORWARD":return void e.go(i);case"@@router/GO_BACK":return void e.go(-1*i);case"@@router/REPLACE":case"@@router/PUSH":var c=i.code,f=i.params;void 0===f&&(f={});var s=t.getState(r.getState()).routes.map[c];if(s){var p=s.href,d={};f&&f.path&&p.parsed&&p.parsed.filter(function(r){return"object"==typeof r}).map(function(r){return r.name}).filter(function(r){return f.path[r]}).forEach(function(r){d[r]=f.path[r]});var v="",l=p.base;p.compiled&&(l=p.compiled(d)),f.query&&(v="?"+(u=f.query,Object.keys(u).map(function(r){return encodeURIComponent(r)+"="+encodeURIComponent(u[r])}).join("&"))),l=""+l+v,"@@router/PUSH"===a?e.pushState(void 0,void 0,l):e.replaceState(void 0,void 0,l);var g=Object.assign({},f);return f&&f.path&&(g.path=d),o({route:s,params:g})}return;default:return}}}}function i(r){var t=function(t){return r(t).result},e=function(r){return t(r).route},n=function(r){return function(t){return e(t)[r]}},o=function(r){return t(r).params},u=function(r){return o(r).path},a=function(r){return o(r).query},i=function(r){return function(t){var e=u(t);if(e)return e[r]}},c=function(r){return function(t){if(a(t))return a(t)[r]}};return{getState:r,getRoute:function(t){return function(e){return r(e).routes.map[t]}},getResult:t,getCurrentCode:function(r){return e(r).code},getCurrentRoute:e,isFound:function(r){return t(r).found},getResultParam:n,getParams:o,getPathParams:u,getQueryParams:a,getPathParam:i,getQueryParam:c,getParam:function(r){return function(t){return n(r)(t)||i(r)(t)||c(r)(t)}}}}function c(){return{type:"@@router/INIT"}}function f(r){return!("object"!=typeof r||!r.code)}var s={history:window&&window.history,location:window&&window.location};function p(t,n){void 0===n&&(n=s);var p=Object.assign({},s,n);if(!p.history)throw new Error("[k-redux-router] no history implementation is given");if(!p.location)throw new Error("[k-redux-router] no location implementation is given");var d={array:function(t){var e=[],n=function(t,o,u){var a={};o&&(a=Object.entries(o).filter(function(r){return!f(r[1])}).reduce(function(r,t){var e;return Object.assign(r,((e={})[t[0]]=t[1],e))},{}));var i=u;o&&(i=Object.assign(a,u,{parent:o&&o.code,href:{base:t,compiled:t.includes(":")?r.compile(t):void 0,regexp:r(t),parsed:r.parse(t)}}),e.push(i)),Object.entries(u).filter(function(r){return f(r[1])}).forEach(function(r){var e=r[1];return n([t,r[0]].join("").replace("//","/"),i,e)})};return n("",void 0,t),e.forEach(function(r){Object.entries(r).forEach(function(t){var e=t[0],n=t[1],o=n;f(n)&&(o=n.code),r[e]=o})}),e}(t)};d.map=d.array.reduce(function(r,t){var e;return Object.assign({},r,((e={})[t.code]=t,e))},{});var v=function(r,t){void 0===t&&(t={});var n=Object.assign({},{routes:r,result:{found:!1}}),o=function(r,t){void 0===r&&(r=n),void 0===t&&(t={});var e=t.payload;switch(t.type){case"@@router/ROUTE_FOUND":return Object.assign({},r,{result:e});default:return r}};return Object.assign(o,i(t.getState||function(r){return r.ui.router})),Object.assign(o,e),o}(d,p);return{middleware:function(r,t,e){var n=!1,i=u(t,e),c=a(t,e);return function(r){return function(t){return function(e){if(!e.type||!e.type.startsWith("@@router/"))return t(e);var u=t(e);"@@router/INIT"===e.type&&(i(r),n?console.warn("[k-redux-router] initialized twice"):(n=!0,window&&(window.onpopstate=function(){i(r)}))),n||e.type===o.type||console.warn("[k-redux-router] router should be initialized");var a=c(r)(e);return a&&r.dispatch(a),u}}}}(0,p,v),reducer:v,init:c}}export{e as actions,p as router,i as selectors};
